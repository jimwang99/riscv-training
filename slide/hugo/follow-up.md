# Follow-up question from yesterday

## 1. What is GP's purpose?

## 2. Software breakpoint

---

## Software breakpoint and `EBREAK` instruction

- Breakpoint is always used for software debug.
- `EBREAK` instruction will trigger a breakpoint exception, and trap into trap handler. Then kernel will decided what to do after that.	

### What does PK do?

#### Example C code

```c
#include <stdio.h>

int main(void) {
    printf("before breakpoint\n");

    asm volatile
        (
         "ebreak\n\t"
         :
         :
        );

    printf("after breakpoint\n");
    return 0;
}
```

---

## Software breakpoint and `EBREAK` instruction

Print out breakpoint info and return.

```assembly
> spike pk bp.elf
bbl loader
before breakpoint
z  0000000000000000 ra 00000000000101c0 sp 000000007f7e9b40 gp 0000000000013f48
tp 0000000000000000 t0 8801000500000001 t1 0000000000000007 t2 0000219000040077
s0 000000007f7e9b50 s1 0000000000000000 a0 000000000000000a a1 0000000000014760
a2 0000000000000012 a3 0000000000000000 a4 0000000000000000 a5 0000000000000001
a6 000000000000000a a7 0000000000000040 s2 0000000000000000 s3 0000000000000000
s4 0000000000000000 s5 0000000000000000 s6 0000000000000000 s7 0000000000000000
s8 0000000000000000 s9 0000000000000000 sA 0000000000000000 sB 0000000000000000
t3 0000000000000000 t4 000000005d3724c0 t5 0000000000000000 t6 0000000000000000
pc 00000000000101c0 va 00000000000101c0 insn       ffffffff sr 8000000200046020
Breakpoint!
z  0000000000000000 ra 0000000000010362 sp 000000007f7e9ad0 gp 0000000000013f48
tp 0000000000000000 t0 8801000500000001 t1 0000000000000007 t2 0000219000040077
s0 0000000000013728 s1 00000000000006e9 a0 00000000000006e9 a1 00000000000006e9
a2 0000000000000012 a3 0000000000000000 a4 00000000000006e9 a5 0000000000000001
a6 000000000000000a a7 0000000000000040 s2 0000000000000000 s3 0000000000000000
s4 0000000000000000 s5 0000000000000000 s6 0000000000000000 s7 0000000000000000
s8 0000000000000000 s9 0000000000000000 sA 0000000000000000 sB 0000000000000000
t3 0000000000000000 t4 000000005d3724c0 t5 0000000000000000 t6 0000000000000000
pc 0000000000010438 va 00000000000006e9 insn       ffffffff sr 8000000200046020
User load segfault @ 0x00000000000006e9
```

## Software breakpoint and `EBREAK` instruction

#### Problem `User load segfault`

-   Demo the process of debugging this problem

-   Cause: `ebreak` is a 16-bit instruction, but the breakpoint handler used `mepc += 4` before `sret` that skipped one necessary 16-bit instruction.
    -   If it's a 32-bit instruction, it will cause `illegal_instruction` exception immediately

#### After apply `.option norvc`

```assembly
> spike -m16 pk bp_norvc.elf
bbl loader
before breakpoint
z  0000000000000000 ra 00000000000101c0 sp 0000000000fd9b40 gp 0000000000013f58
tp 0000000000000000 t0 8800000503e80001 t1 0000000000000007 t2 000021900003000e
s0 0000000000fd9b50 s1 0000000000000000 a0 000000000000000a a1 0000000000014770
a2 0000000000000012 a3 0000000000000000 a4 0000000000000000 a5 0000000000000001
a6 000000000000000a a7 0000000000000040 s2 0000000000000000 s3 0000000000000000
s4 0000000000000000 s5 0000000000000000 s6 0000000000000000 s7 0000000000000000
s8 0000000000000000 s9 0000000000000000 sA 0000000000000000 sB 0000000000000000
t3 0000000000000000 t4 000000005d378e40 t5 0000000000000000 t6 0000000000000000
pc 00000000000101c0 va 00000000000101c0 insn       ffffffff sr 8000000200046020
Breakpoint!
after breakpoint
```


# Welcome to my blog 
### http://phdbreak99.github.io

&nbsp;

# Training material

### http://phdbreak99.github.io/riscv-training/list.html

### http://github.com/phdbreak99/riscv-training

&nbsp;

# Welcome to connect me on LinkedIn

### https://www.linkedin.com/in/wangjun99


